<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reviewer</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body class="apps-page reviewer-page">
  <a href="apps.html" class="apps-button back-button">Apps</a>

  <div class="container reviewer-container">
    <h1>Reviewer</h1>
    <p class="apps-intro reviewer-intro">
      Summon a focused study guide powered by Google Gemini. Describe a topic, pick how many Q&A items you want, review the summaries, then challenge yourself with a randomized quiz.
    </p>

    <section class="reviewer-form" role="form" aria-label="Generate AI reviewer">
      <div class="form-field">
        <label for="topicInput">What do you want to study?</label>
        <textarea id="topicInput" rows="3" placeholder="e.g., Medical study about feet, Philippine history on EDSA Revolution" required></textarea>
      </div>

      <div class="form-field">
        <label for="questionPreset">How many questions?</label>
        <div class="count-control">
          <select id="questionPreset">
            <option value="10">10 questions</option>
            <option value="20">20 questions</option>
            <option value="30">30 questions</option>
            <option value="40">40 questions</option>
            <option value="50">50 questions</option>
            <option value="custom">Custom (1-100)</option>
          </select>
          <input type="number" id="customCount" min="1" max="100" placeholder="25" aria-label="Custom question count" disabled />
        </div>
      </div>

      <div class="form-field reviewer-actions">
        <button id="generateBtn" type="button">
          <i class="fas fa-brain"></i>&nbsp;Generate reviewer
        </button>
        <button id="resetBtn" type="button" class="ghost-button">
          <i class="fas fa-rotate"></i>&nbsp;Reset
        </button>
      </div>
    </section>

    <div class="advisor-status reviewer-status" id="statusBox" role="status" aria-live="polite">
      <strong><i class="fas fa-info-circle"></i>&nbsp;Waiting for a topic</strong>
      <p>Describe the subject you want to review and choose how many entries to generate.</p>
    </div>

    <section class="reviewer-output" id="reviewerSection" hidden aria-label="Reviewer cards">
      <div class="section-heading">
        <h2><i class="fas fa-book"></i>&nbsp;Reviewer</h2>
        <p>Scan these concise definitions before testing yourself.</p>
      </div>
      <div class="reviewer-cards" id="reviewerList"></div>
      <div class="reviewer-cta" id="quizCta" hidden>
        <div>
          <p class="quiz-topic" id="quizTopicLabel"></p>
          <p class="quiz-count" id="quizCountLabel"></p>
          <p>Ready to test your recall? Launch the quiz to get randomized multiple-choice questions.</p>
        </div>
        <button id="takeQuizBtn" type="button">
          <i class="fas fa-question-circle"></i>&nbsp;Take the quiz
        </button>
      </div>
    </section>

    <section class="advisor-notes" aria-label="Gemini API instructions">
      <h2><i class="fas fa-key"></i>&nbsp;API setup</h2>
      <ul>
        <li>Set your Google Gemini API key inside the <code>GEMINI_API_KEY</code> constant in this page.</li>
        <li>The key only lives in your browser and is used directly for each request.</li>
        <li>AI answers may be inaccurateâ€”verify critical facts before memorizing.</li>
      </ul>
    </section>
  </div>

  <script>
    (() => {
      const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
      const GEMINI_API_KEY = 'AIzaSyAi9o1H0rBWqafr5k3op4_iKEn5q80c2Rc'; // TODO: Replace with your Gemini API key.

      const topicInput = document.getElementById('topicInput');
      const questionPreset = document.getElementById('questionPreset');
      const customCountInput = document.getElementById('customCount');
      const generateBtn = document.getElementById('generateBtn');
      const resetBtn = document.getElementById('resetBtn');
      const statusBox = document.getElementById('statusBox');
      const reviewerSection = document.getElementById('reviewerSection');
      const reviewerList = document.getElementById('reviewerList');
      const quizCta = document.getElementById('quizCta');
      const takeQuizBtn = document.getElementById('takeQuizBtn');
      const quizTopicLabel = document.getElementById('quizTopicLabel');
      const quizCountLabel = document.getElementById('quizCountLabel');

      const STORAGE_KEY = 'reviewerQuizData';

      const state = {
        reviewerEntries: [],
        quizItems: [],
        topic: '',
        questionCount: 0,
      };

      /**
       * Updates the status ribbon tone + message.
       * @param {string} message
       * @param {'info'|'success'|'error'} tone
       */
      const updateStatus = (message, tone = 'info') => {
        statusBox.dataset.tone = tone;
        const toneIcon = tone === 'success' ? 'fa-circle-check' : tone === 'error' ? 'fa-triangle-exclamation' : 'fa-info-circle';
        const toneLabel = tone === 'success' ? 'Ready' : tone === 'error' ? 'Issue detected' : 'Working';
        statusBox.querySelector('strong').innerHTML = `<i class="fas ${toneIcon}"></i>&nbsp;${toneLabel}`;
        statusBox.querySelector('p').textContent = message;
      };

      const toggleCustomCount = () => {
        const isCustom = questionPreset.value === 'custom';
        customCountInput.disabled = !isCustom;
        customCountInput.setAttribute('aria-hidden', String(!isCustom));
        if (!isCustom) {
          customCountInput.value = '';
        } else {
          customCountInput.focus();
        }
      };

      /**
       * Resolves the requested question total.
       * @returns {number}
       */
      const getQuestionCount = () => {
        if (questionPreset.value !== 'custom') {
          return Number(questionPreset.value);
        }
        const customValue = Number(customCountInput.value);
        if (!Number.isInteger(customValue)) {
          throw new Error('Enter a whole number between 1 and 100.');
        }
        if (customValue < 1 || customValue > 100) {
          throw new Error('Custom question counts must stay between 1 and 100.');
        }
        return customValue;
      };

      /**
       * Builds the Gemini prompt.
       * @param {string} topic
       * @param {number} count
       * @returns {string}
       */
      const buildPrompt = (topic, count) => `You are an expert study coach. Create a reviewer and matching multiple-choice quiz about: ${topic}.
Return ONLY a JSON object inside one fenced code block using this schema:
{
  "reviewerEntries": [
    { "term": "", "definition": "", "keyTakeaway": "", "memoryHook": "" }
  ],
  "quizItems": [
    { "question": "", "choices": [""], "answerIndex": 0, "answerExplanation": "" }
  ]
}
Guidelines:
- Provide exactly ${count} reviewerEntries and ${count} quizItems.
- Definitions must stay under 60 words, plain English, still mention critical domain jargon.
- Each quiz question needs 4 concise, distinct choices. answerIndex is the zero-based correct choice.
- Use neutral, factual tone. Avoid markdown, LaTeX, or stray commentary.`;

      /**
       * Calls Gemini and returns structured data.
       * @param {string} topic
       * @param {number} count
       * @param {string} apiKey
       * @returns {Promise<{ reviewerEntries: any[]; quizItems: any[]; }>}
       */
      const requestGeminiReviewer = async (topic, count, apiKey) => {
        const response = await fetch(`${API_URL}?key=${encodeURIComponent(apiKey)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              {
                role: 'user',
                parts: [{ text: buildPrompt(topic, count) }],
              },
            ],
            safetySettings: [
              { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' },
              { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
            ],
          }),
        });

        if (!response.ok) {
          const detail = await response.text();
          throw new Error(`Gemini API error: ${response.status} ${detail}`);
        }

        const data = await response.json();
        const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!textResult) {
          throw new Error('Gemini response was empty.');
        }
        return parseReviewerPayload(textResult);
      };

      /**
       * Extracts JSON payload from Gemini text output.
       * @param {string} text
       */
      const parseReviewerPayload = (text) => {
        const match = text.match(/```json\s*([\s\S]*?)```/i) || text.match(/```\s*([\s\S]*?)```/i);
        if (!match) {
          throw new Error('Gemini response missing JSON block.');
        }
        const payload = JSON.parse(match[1]);
        if (!Array.isArray(payload.reviewerEntries) || payload.reviewerEntries.length === 0) {
          throw new Error('Reviewer entries missing from Gemini response.');
        }
        if (!Array.isArray(payload.quizItems) || payload.quizItems.length === 0) {
          throw new Error('Quiz items missing from Gemini response.');
        }
        return payload;
      };

      const setQuizMetaLabels = () => {
        if (state.topic) {
          quizTopicLabel.textContent = `Topic: ${state.topic}`;
          quizTopicLabel.hidden = false;
        } else {
          quizTopicLabel.textContent = '';
          quizTopicLabel.hidden = true;
        }

        if (state.questionCount) {
          quizCountLabel.textContent = `Questions prepared: ${state.questionCount}`;
          quizCountLabel.hidden = false;
        } else {
          quizCountLabel.textContent = '';
          quizCountLabel.hidden = true;
        }
      };

      /**
       * Renders reviewer cards.
       * @param {{ term: string; definition: string; keyTakeaway?: string; memoryHook?: string; }[]} entries
       * @param {{ focusButton?: boolean }} options
       */
      const renderReviewer = (entries, { focusButton = true } = {}) => {
        const cards = entries.map((entry, index) => {
          const title = entry.term || `Item ${index + 1}`;
          const definition = entry.definition || 'Definition unavailable.';
          const keyTakeaway = entry.keyTakeaway ? `<p class="takeaway"><strong>Key takeaway:</strong> ${entry.keyTakeaway}</p>` : '';
          const memoryHook = entry.memoryHook ? `<p class="memory"><strong>Memory hook:</strong> ${entry.memoryHook}</p>` : '';
          return `<article class="review-card">
            <h3>${title}</h3>
            <p>${definition}</p>
            ${keyTakeaway}
            ${memoryHook}
          </article>`;
        });
        reviewerList.innerHTML = cards.join('');
        reviewerSection.hidden = false;
        quizCta.hidden = false;
        setQuizMetaLabels();
        if (focusButton) {
          takeQuizBtn.focus();
        }
      };

      const hydrateFromStorage = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const saved = JSON.parse(raw);
          if (!Array.isArray(saved.reviewerEntries) || !saved.reviewerEntries.length || !Array.isArray(saved.quizItems) || !saved.quizItems.length) {
            localStorage.removeItem(STORAGE_KEY);
            return;
          }
          state.reviewerEntries = saved.reviewerEntries;
          state.quizItems = saved.quizItems;
          state.topic = saved.topic || 'Custom topic';
          state.questionCount = Number(saved.questionCount) || saved.quizItems.length;
          renderReviewer(saved.reviewerEntries, { focusButton: false });
          updateStatus('Loaded your last reviewer. You can regenerate anytime.', 'info');
        } catch (error) {
          console.error('Failed to hydrate reviewer data', error);
          localStorage.removeItem(STORAGE_KEY);
        }
      };

      questionPreset.addEventListener('change', toggleCustomCount);
      hydrateFromStorage();

      generateBtn.addEventListener('click', async () => {
        const topic = topicInput.value.trim();
        if (!topic) {
          updateStatus('Describe the topic you want to review.', 'error');
          return;
        }
        if (!GEMINI_API_KEY?.trim()) {
          updateStatus('Set your Gemini API key inside GEMINI_API_KEY before continuing.', 'error');
          return;
        }

        let questionCount;
        try {
          questionCount = getQuestionCount();
        } catch (error) {
          updateStatus(error.message, 'error');
          return;
        }

        updateStatus('Contacting Gemini to craft your reviewer...', 'info');
        generateBtn.disabled = true;
        resetBtn.disabled = true;

        try {
          const payload = await requestGeminiReviewer(topic, questionCount, GEMINI_API_KEY);
          state.reviewerEntries = payload.reviewerEntries;
          state.quizItems = payload.quizItems;
          state.topic = topic;
          state.questionCount = questionCount;
          renderReviewer(payload.reviewerEntries);
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            topic,
            generatedAt: new Date().toISOString(),
            questionCount,
            reviewerEntries: payload.reviewerEntries,
            quizItems: payload.quizItems,
          }));
          updateStatus('Reviewer and quiz ready. Study first, then take the quiz!', 'success');
          reviewerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (error) {
          console.error(error);
          updateStatus(error.message, 'error');
        } finally {
          generateBtn.disabled = false;
          resetBtn.disabled = false;
        }
      });

      resetBtn.addEventListener('click', () => {
        topicInput.value = '';
        questionPreset.value = '10';
        toggleCustomCount();
        reviewerSection.hidden = true;
        reviewerList.innerHTML = '';
        quizCta.hidden = true;
        state.reviewerEntries = [];
        state.quizItems = [];
        state.topic = '';
        state.questionCount = 0;
        setQuizMetaLabels();
        localStorage.removeItem(STORAGE_KEY);
        updateStatus('Cleared inputs. Describe a fresh topic to begin again.', 'info');
      });

      takeQuizBtn.addEventListener('click', () => {
        if (!state.quizItems.length) {
          updateStatus('Generate a reviewer first so the quiz has data to work with.', 'error');
          return;
        }
        window.location.href = 'reviewer-quiz.html';
      });
    })();
  </script>
</body>
</html>
