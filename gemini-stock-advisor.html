<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Stock Advisor</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body class="apps-page advisor-page">
  <a href="apps.html" class="apps-button back-button">Apps</a>

  <div class="container">
    <h1>Gemini Stock Advisor</h1>
    <p class="apps-intro" style="text-align:center">
      Generate a 7-day stock outlook with insights from Google Gemini. Enter a ticker, provide your API key, and review the daily guidance.
    </p>

    <div class="tax-inputs advisor-inputs" role="form" aria-label="Gemini stock advisor">
      <div class="tax-field">
        <label for="tickerInput">Stock symbol</label>
        <input id="tickerInput" type="text" placeholder="e.g. PSEI, AAPL" autocapitalize="characters" />
      </div>

      <div class="tax-field">
        <label for="marketSelect">Market</label>
        <select id="marketSelect">
          <option value="philippines">Philippines</option>
          <option value="us">United States</option>
          <option value="global">Global</option>
        </select>
      </div>

      <div class="tax-buttons advisor-buttons">
        <button id="analyzeBtn" type="button">
          <i class="fas fa-chart-line"></i>&nbsp;Get 7-Day Outlook
        </button>
        <button id="clearBtn" type="button" class="ghost-button">
          <i class="fas fa-eraser"></i>&nbsp;Clear
        </button>
      </div>
    </div>

    <div class="advisor-status" id="statusBox" role="status" aria-live="polite">
      <strong><i class="fas fa-info-circle"></i>&nbsp;Waiting for analysis</strong>
      <p>Enter a stock symbol and press <em>Analyze</em> to fetch Gemini insights.</p>
    </div>

    <section class="advisor-outlook" id="outlookSection" hidden aria-label="Weekly outlook">
      <h2><i class="fas fa-calendar-week"></i>&nbsp;Weekly Outlook</h2>
      <ol id="outlookList" class="advisor-outlook-list"></ol>
    </section>

    <section class="advisor-report" id="reportSection" hidden>
      <h2><i class="fas fa-comments"></i>&nbsp;Gemini Guidance</h2>
      <article id="guidanceText"></article>
    </section>

    <section class="advisor-notes" aria-label="Usage notes">
      <h2><i class="fas fa-key"></i>&nbsp;Before you begin</h2>
      <ul>
        <li>Set your <strong>Google Gemini API key</strong> inside the <code>GEMINI_API_KEY</code> constant in this page's script.</li>
        <li>The key stays on this page and is only used for Gemini API requests.</li>
        <li>Outputs are AI-generated forecasts — verify with real market data before making trades.</li>
      </ul>
    </section>
  </div>

  <script>
    (function () {
      const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent';
      const GEMINI_API_KEY = 'AIzaSyAi9o1H0rBWqafr5k3op4_iKEn5q80c2Rc'; // TODO: replace this string with your real Gemini API key
      const analyzeBtn = document.getElementById('analyzeBtn');
      const clearBtn = document.getElementById('clearBtn');
      const tickerInput = document.getElementById('tickerInput');
      const marketSelect = document.getElementById('marketSelect');
      const statusBox = document.getElementById('statusBox');
      const guidanceText = document.getElementById('guidanceText');
      const reportSection = document.getElementById('reportSection');
      const outlookSection = document.getElementById('outlookSection');
      const outlookList = document.getElementById('outlookList');

      /**
       * Updates the status panel with helper text.
       * @param {string} message
       * @param {('info'|'success'|'error')} tone
       */
      function updateStatus(message, tone = 'info') {
        statusBox.dataset.tone = tone;
        const toneIcon = tone === 'success' ? 'fa-check-circle' : tone === 'error' ? 'fa-triangle-exclamation' : 'fa-info-circle';
        statusBox.querySelector('strong').innerHTML = `<i class="fas ${toneIcon}"></i>&nbsp;${tone === 'success' ? 'Analysis ready' : tone === 'error' ? 'Request failed' : 'Working'}`;
        statusBox.querySelector('p').textContent = message;
      }

      /**
       * Builds a structured prompt for Gemini.
       * @param {string} symbol
       * @param {string} market
       * @returns {string}
       */
      function buildPrompt(symbol, market) {
        return `You are a prudent financial analyst. Provide a one-week outlook (seven-day window) for ${symbol} in the ${market} market.
Respond ONLY with JSON using this schema:
{
  "summary": "Markdown-friendly paragraph",
  "currency": "PHP or USD",
  "weeklyOutlook": [
    { "day": "2024-11-18", "prediction": "Trend insight", "confidence": "low|medium|high", "priceTarget": 123.45 }
    ... exactly 7 entries covering the next seven calendar days ...
  ],
  "keyDrivers": ["factor", "factor"],
  "riskFactors": ["risk", "risk"]
}
Do not include any other text outside a single fenced JSON block.`;
      }

      /**
       * Parses Gemini text output to extract JSON payload.
       * @param {string} text
       * @returns {{ summary: string, currency: string, monthlyPoints: {month: string, price: number}[], keyDrivers: string[], riskFactors: string[] }}
       */
      function parseAdvisoryResponse(text) {
        const match = text.match(/```json\s*([\s\S]*?)```/i) || text.match(/```\s*([\s\S]*?)```/i);
        if (!match) {
          throw new Error('Gemini response missing JSON block.');
        }
        const payload = JSON.parse(match[1]);
        if (!Array.isArray(payload.weeklyOutlook) || payload.weeklyOutlook.length === 0) {
          throw new Error('Gemini response missing weekly outlook.');
        }
        return payload;
      }

      /**
       * Calls Gemini API for advisory data.
       * @param {string} symbol
       * @param {string} market
       * @param {string} apiKey
       * @returns {Promise<any>}
       */
      async function requestGemini(symbol, market, apiKey) {
        const response = await fetch(`${API_URL}?key=${encodeURIComponent(apiKey)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              {
                role: 'user',
                parts: [{ text: buildPrompt(symbol, market) }],
              },
            ],
            safetySettings: [
              { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' },
            ],
          }),
        });

        if (!response.ok) {
          const detail = await response.text();
          throw new Error(`Gemini API error: ${response.status} ${detail}`);
        }

        const data = await response.json();
        const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!textResult) {
          throw new Error('No advisory text received.');
        }
        return parseAdvisoryResponse(textResult);
      }

      function renderOutlook(outlook, currency) {
        if (!Array.isArray(outlook) || outlook.length === 0) {
          throw new Error('Gemini response missing daily predictions.');
        }

        const fmt = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: currency.toUpperCase() === 'PHP' ? 'PHP' : 'USD',
          maximumFractionDigits: 2,
        });

        const items = outlook.map((item, index) => {
          let date = typeof item.day === 'string' ? new Date(item.day) : new Date();
          if (Number.isNaN(date.getTime())) {
            date = new Date();
            date.setDate(date.getDate() + index);
          }
          const formattedDate = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          const priceTarget = Number.isFinite(Number(item.priceTarget)) ? fmt.format(Number(item.priceTarget)) : '—';
          const confidence = (item.confidence || 'unknown').toUpperCase();
          const insight = item.prediction || 'No insight provided.';
          return `<li>
            <div class="outlook-date">${formattedDate}</div>
            <div class="outlook-body">
              <p>${insight}</p>
              <div class="outlook-meta"><span>Target: ${priceTarget}</span><span>Confidence: ${confidence}</span></div>
            </div>
          </li>`;
        });

        outlookList.innerHTML = items.join('');
        outlookSection.hidden = false;
      }

      function renderReport(payload, symbol) {
        reportSection.hidden = false;
        const drivers = payload.keyDrivers?.length ? `<h3>Key Drivers</h3><ul>${payload.keyDrivers.map((d) => `<li>${d}</li>`).join('')}</ul>` : '';
        const risks = payload.riskFactors?.length ? `<h3>Risks to watch</h3><ul>${payload.riskFactors.map((r) => `<li>${r}</li>`).join('')}</ul>` : '';
        guidanceText.innerHTML = `<p>${payload.summary}</p>${drivers}${risks}`;
      }

      analyzeBtn.addEventListener('click', async () => {
        const symbol = tickerInput.value.trim().toUpperCase();
        const market = marketSelect.value;

        if (!symbol) {
          updateStatus('Please enter a stock symbol, e.g., AAPL or SMPH.', 'error');
          return;
        }
        if (!GEMINI_API_KEY?.trim()) {
          updateStatus('Set your Gemini API key inside GEMINI_API_KEY in the code.', 'error');
          return;
        }

        updateStatus('Contacting Gemini for projections...', 'info');
        analyzeBtn.disabled = true;
        clearBtn.disabled = true;

        try {
          const payload = await requestGemini(symbol, market, GEMINI_API_KEY);
          renderOutlook(payload.weeklyOutlook, payload.currency || 'USD');
          renderReport(payload, symbol);
          updateStatus('Review the weekly outlook and guidance below.', 'success');
        } catch (error) {
          console.error(error);
          updateStatus(error.message, 'error');
        } finally {
          analyzeBtn.disabled = false;
          clearBtn.disabled = false;
        }
      });

      clearBtn.addEventListener('click', () => {
        tickerInput.value = '';
        marketSelect.value = 'philippines';
        reportSection.hidden = true;
        guidanceText.innerHTML = '';
        outlookSection.hidden = true;
        outlookList.innerHTML = '';
        updateStatus('Cleared inputs. Enter a stock symbol to try again.', 'info');
      });
    })();
  </script>
</body>
</html>
